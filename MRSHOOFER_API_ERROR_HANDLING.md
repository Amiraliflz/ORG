# ุฑุงูููุง ูุฏุฑุช ุฎุทุงูุง MrShoofer API

## ๐จ ูุดฺฉู

ุฒูุงู ฺฉู MrShoofer API ุฎุทุง **500 (Internal Server Error)** ุจุฑูโฺฏุฑุฏุงูุฏุ ุจุฑูุงูู ูุชููู ูโุดุฏ ู ฺฉุงุฑุจุฑ ุตูุญู ุฎุทุง ูโุฏุฏ.

## โ ุฑุงูโุญู ูพุงุฏูโุณุงุฒ ุดุฏู

### **1. Retry Logic ุจุง Exponential Backoff**

ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช ุจู MrShoofer APIุ ูฺฉุงูุฒู retry ุจุง ุชุงุฎุฑ ุชุตุงุนุฏ ุงุถุงูู ุดุฏ:

```csharp
int retryCount = 0;
int maxRetries = 3;

while (retryCount < maxRetries)
{
    try
    {
        trip = await apiclient.GetTripInfo(tripcode);
        break; // ููููุช - ุฎุฑูุฌ ุงุฒ ุญููู
    }
    catch (HttpRequestException ex) when (retryCount < maxRetries - 1)
    {
        retryCount++;
        await Task.Delay(1000 * retryCount); // ุชุงุฎุฑ: 1s, 2s, 3s
    }
}
```

### **2. ุชุงุฎุฑ ุชุตุงุนุฏ (Exponential Backoff)**

```
ุชูุงุด 1: ุจุฏูู ุชุงุฎุฑ
ุชูุงุด 2: 1 ุซุงูู ุชุงุฎุฑ
ุชูุงุด 3: 2 ุซุงูู ุชุงุฎุฑ
ุชูุงุด 4: 3 ุซุงูู ุชุงุฎุฑ
```

ุงู ุฑูุด:
- โ ุจู API ูุฑุตุช ุจุงุฒุงุจ ูโุฏูุฏ
- โ ุงุฒ ุณุฑุฑุฒ (overload) ุณุฑูุฑ ุฌููฺฏุฑ ูโฺฉูุฏ
- โ ุดุงูุณ ููููุช ุฑุง ุงูุฒุงุด ูโุฏูุฏ

### **3. ูุงฺฏโฺฏุฑ ุฏูู**

```csharp
_logger.LogWarning(ex, "MrShoofer API error (attempt {Attempt}/{MaxRetries}). Retrying...", 
    retryCount, maxRetries);
```

ูุฑ ุฎุทุง ู ุชูุงุด ูุฌุฏุฏ ูุงฺฏ ูโุดูุฏ ุจุฑุง debugging.

### **4. ูพุงูโูุง ฺฉุงุฑุจุฑูพุณูุฏ**

ุจู ุฌุง ููุงุด ุฎุทุง ููุ ูพุงูโูุง ูุงุฑุณ ููุงุณุจ ููุงุด ุฏุงุฏู ูโุดูุฏ:

```csharp
TempData["ErrorMessage"] = "ุฏุฑ ุญุงู ุญุงุถุฑ ุงูฺฉุงู ุงุชุตุงู ุจู ุณุฑูุณ ุฑุฒุฑู ูุฌูุฏ ูุฏุงุฑุฏ. ูุทูุงู ฺูุฏ ุฏููู ุฏฺฏุฑ ูุฌุฏุฏุงู ุชูุงุด ฺฉูุฏ.";
```

---

## ๐ ูุญูโูุง ูพุงุฏูโุณุงุฒ

### **1. `Reservetrip` (GET)**
- ูฺฉุงู: `ReserveController.Reservetrip(string tripcode)`
- ุนููฺฉุฑุฏ: ุฏุฑุงูุช ุงุทูุงุนุงุช ุณูุฑ ุจุฑุง ููุงุด ูุฑู ุฑุฒุฑู
- Retry: 3 ุชูุงุด ุจุง ุชุงุฎุฑ ุชุตุงุนุฏ

### **2. `Reservetrip` (POST)**
- ูฺฉุงู: `ReserveController.Reservetrip(ReserveInfoViewModel viewmodel)`
- ุนููฺฉุฑุฏ: ุฏุฑุงูุช ุงุทูุงุนุงุช ุณูุฑ ุจุฑุง ุตูุญู ุชุงุฏ
- Retry: 3 ุชูุงุด ุจุง ุชุงุฎุฑ ุชุตุงุนุฏ

### **3. `ConfirmInfo` (POST)**
- ูฺฉุงู: `ReserveController.ConfirmInfo(ConfirmInfoViewModel viewModel)`
- ุนููฺฉุฑุฏ: ุฏุฑุงูุช ุงุทูุงุนุงุช ุณูุฑ ูุจู ุงุฒ ุงุฌุงุฏ ุฑุฒุฑู
- Retry: 3 ุชูุงุด ุจุง ุชุงุฎุฑ ุชุตุงุนุฏ
- **ููู:** ุงู ูุจู ุงุฒ ูพุฑุฏุงุฎุช ุงุชูุงู ูโุงูุชุฏ

---

## ๐ ุฌุฑุงู ฺฉุงุฑ ุจุง Retry

```
ฺฉุงุฑุจุฑ ุฏุฑุฎูุงุณุช ูโฺฉูุฏ
    โ
ุชูุงุด 1: ูุฑุงุฎูุงู API
    โ ุฎุทุง 500
ุชุงุฎุฑ 1 ุซุงูู
    โ
ุชูุงุด 2: ูุฑุงุฎูุงู API ูุฌุฏุฏ
    โ ุฎุทุง 500
ุชุงุฎุฑ 2 ุซุงูู
    โ
ุชูุงุด 3: ูุฑุงุฎูุงู API ูุฌุฏุฏ
    โ ุฎุทุง 500
ุชุงุฎุฑ 3 ุซุงูู
    โ
ุชูุงุด 4: ูุฑุงุฎูุงู API ูุฌุฏุฏ
    โ
    โโ ููููุช โ โ ุงุฏุงูู ูุฑุขูุฏ
    โโ ุฎุทุง โ โ ููุงุด ูพุงู ุฎุทุง ุจู ฺฉุงุฑุจุฑ
```

---

## ๐ ูุฏุฑุช ุฎุทุงูุง

### **ุฎุทุงูุง ูุฏุฑุช ุดุฏู:**

| ููุน ุฎุทุง | ฺฉุฏ ุฎุทุง | ูุงฺฉูุด |
|---------|--------|-------|
| `HttpRequestException` | 500 | 3 ุชูุงุด ูุฌุฏุฏ ุจุง ุชุงุฎุฑ |
| `TaskCanceledException` | Timeout | ูพุงู ูุงุฑุณ ุจุฑุง ฺฉุงุฑุจุฑ |
| `Exception` (ุนููู) | ูุฑ ุฎุทุง ุฏฺฏุฑ | ูุงฺฏ + ูพุงู ุฎุทุง |

### **ูพุงูโูุง ุฎุทุง ูุงุฑุณ:**

```csharp
// ุฎุทุง ุงุชุตุงู
"ุฏุฑ ุญุงู ุญุงุถุฑ ุงูฺฉุงู ุงุชุตุงู ุจู ุณุฑูุณ ุฑุฒุฑู ูุฌูุฏ ูุฏุงุฑุฏ. ูุทูุง ุจุนุฏุง ุชูุงุด ฺฉูุฏ"

// ุฎุทุง timeout
"ุฒูุงู ุงุชุตุงู ุจู ุณุฑูุณ ุจู ูพุงุงู ุฑุณุฏ. ูุทูุง ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ"

// ุฎุทุง ุนููู
"ุฎุทุง ุฑุฎ ุฏุงุฏู ุงุณุช. ูุทูุง ุจุนุฏุง ุชูุงุด ฺฉูุฏ"

// ุฎุทุง ุจุนุฏ ุงุฒ ููู ุชูุงุดโูุง
"ุฏุฑ ุญุงู ุญุงุถุฑ ุงูฺฉุงู ุงุชุตุงู ุจู ุณุฑูุณ ุฑุฒุฑู ูุฌูุฏ ูุฏุงุฑุฏ. ูุทูุงู ฺูุฏ ุฏููู ุฏฺฏุฑ ูุฌุฏุฏุงู ุชูุงุด ฺฉูุฏ."
```

---

## โ๏ธ ุชูุธูุงุช

ุจุฑุง ุชุบุฑ ุชุนุฏุงุฏ ุชูุงุดโูุง ุง ุฒูุงู ุชุงุฎุฑ:

```csharp
// ุชุนุฏุงุฏ ุชูุงุดโูุง (ูพุดโูุฑุถ: 3)
int maxRetries = 3;

// ูุฑููู ุชุงุฎุฑ (ูพุดโูุฑุถ: retryCount * 1000 ููโุซุงูู)
await Task.Delay(1000 * retryCount);

// ุจุฑุง ุชุบุฑ ุจู ุชุงุฎุฑ ุซุงุจุช 2 ุซุงูู:
await Task.Delay(2000);

// ุจุฑุง ุชุบุฑ ุจู ุชุงุฎุฑ ุชุตุงุนุฏ ุณุฑุนโุชุฑ:
await Task.Delay(500 * retryCount); // 0.5s, 1s, 1.5s
```

---

## ๐งช ุชุณุช

### **ุชุณุช ุฏุณุช:**

1. ูุทุน ุงูุชุฑูุช ฺฉู
2. ุณุน ฺฉู ฺฉ ุณูุฑ ุงูุชุฎุงุจ ฺฉู
3. ุจุงุฏ 3 ุชูุงุด ูุดุงูุฏู ฺฉู (ุฏุฑ logs)
4. ุจุนุฏ ุงุฒ 6 ุซุงูู (1+2+3) ุจุงุฏ ูพุงู ุฎุทุง ุฑู ุจุจู

### **ุชุณุช ุจุง MrShoofer API:**

1. ฺฉ tripcode ูุนุชุจุฑ ุงูุชุฎุงุจ ฺฉู
2. ุงฺฏุฑ API ุฎุทุง ุจุฑฺฏุฑุฏููุฏุ ุณุณุชู ุฎูุฏฺฉุงุฑ retry ูโฺฉูู
3. ุฏุฑ Output logs ูโุชูู ุจุจู:
   ```
   warn: Application.Areas.AgencyArea.ReserveController[0]
         MrShoofer API error (attempt 1/3). Retrying...
   ```

---

## ๐ ูฺฉุงุช ููู

### **1. ฺุฑุง ูุจู ุงุฒ ูพุฑุฏุงุฎุชุ**
- ุงฺฏุฑ API ฺฉุงุฑ ูฺฉููุ ฺฉุงุฑุจุฑ ูพูู ููโุฏู
- ุฌููฺฏุฑ ุงุฒ ูพุฑุฏุงุฎุช ุจุฏูู ุฑุฒุฑู

### **2. ฺุฑุง ุชุงุฎุฑ ุชุตุงุนุฏุ**
- ุณุฑูุฑ ูุฑุตุช ุจุงุฒุงุจ ุฏุงุฑู
- ุฌููฺฏุฑ ุงุฒ ุณุฑุฑุฒ ุณุฑูุฑ ุจุง ุฏุฑุฎูุงุณุชโูุง ูฺฉุฑุฑ

### **3. ฺุฑุง 3 ุชูุงุดุ**
- ุชุนุงุฏู ุจู ุตุจุฑ ฺฉุงุฑุจุฑ ู ุดุงูุณ ููููุช
- ุจุดุชุฑ ุงุฒ 3 ุชูุงุด โ ฺฉุงุฑุจุฑ ุฎุณุชู ูโุดู
- ฺฉูุชุฑ ุงุฒ 3 ุชูุงุด โ ุดุงูุณ ฺฉูุชุฑ ููููุช

---

## ๐ง ุจูุจูุฏูุง ุขูุฏู

### **1. Circuit Breaker Pattern**
ุงฺฏุฑ API ูฺฉุฑุฑุงู ุฎุทุง ุจุฏูุ ุจุฑุง ูุฏุช ุฏฺฏู ุฏุฑุฎูุงุณุช ููุฑุณุชู:

```csharp
// TODO: ูพุงุฏูโุณุงุฒ Circuit Breaker
if (_circuitBreaker.IsOpen)
{
    TempData["ErrorMessage"] = "ุณุฑูุณ ุฑุฒุฑู ูููุชุงู ุฏุฑ ุฏุณุชุฑุณ ูุณุช";
    return RedirectToAction("Index", "Home");
}
```

### **2. Caching**
ฺฉุด ฺฉุฑุฏู ุงุทูุงุนุงุช ุณูุฑูุง ุจุฑุง ฺฉุงูุด ุฏุฑุฎูุงุณุช ุจู API:

```csharp
// TODO: ุงุณุชูุงุฏู ุงุฒ IMemoryCache
var cachedTrip = _cache.Get<SearchedTrip>($"trip_{tripcode}");
```

### **3. Health Check**
ฺฺฉ ฺฉุฑุฏู ุณูุงูุช API ูุจู ุงุฒ ุฏุฑุฎูุงุณุช ุงุตู:

```csharp
// TODO: Health Check endpoint
var isHealthy = await _mrShooferHealthCheck.IsHealthyAsync();
```

---

## ๐ ูพุดุชุจุงู

ุฏุฑ ุตูุฑุช ุจุฑูุฒ ูุดฺฉู:
1. ูุงฺฏโูุง ุณุฑูุฑ ุฑู ฺฺฉ ฺฉู (`Output` window ุฏุฑ Visual Studio)
2. ุฏูุจุงู ูพุงูโูุง `warn` ู `error` ุจฺฏุฑุฏ
3. ุชุนุฏุงุฏ ุชูุงุดโูุง ุฑู ุจุจู
4. ุงฺฏู ููู ุชูุงุดโูุง fail ุดุฏูุ ูุดฺฉู ุงุฒ ุณูุช MrShoofer API ูุณุช

---

**ุขุฎุฑู ุจุฑูุฒุฑุณุงู:** 2024-12-16
**ูุณุฎู:** 1.0
