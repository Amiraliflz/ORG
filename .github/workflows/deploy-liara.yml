name: Deploy to Liara

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'liara.json'
      - '**/*.cs'
      - '**/*.csproj'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build & Publish
        run: |
          dotnet restore Application.csproj
          dotnet publish Application.csproj -c Release -o publish

      - name: Build Docker image
        run: docker build -t liara-deploy:latest .

      - name: Install Liara CLI
        run: |
          curl -fsSL https://liara.ir/cli.sh | bash
          echo "Liara CLI installed"

      - name: Authenticate Liara
        env:
          LIARA_TOKEN: ${{ secrets.LIARA_TOKEN }}
        run: liara login --api-token "$LIARA_TOKEN"

      - name: Deploy to Liara
        env:
          LIARA_TOKEN: ${{ secrets.LIARA_TOKEN }}
        run: |
          liara deploy --app mrshoofer-orgselling --port 5000 --path . --detached

