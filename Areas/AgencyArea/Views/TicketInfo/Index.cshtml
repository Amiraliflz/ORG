@using Application.Services
@{

	ViewData["Title"] = "بلیط ها";



	Layout = "_AgencySideLayout";
}

@section VendorStyles {
	<link rel="stylesheet" href="~/vendor/libs/flatpickr/flatpickr.css" />
	<link rel="stylesheet" href="~/vendor/libs/bootstrap-datepicker/bootstrap-datepicker.css" />
	<link rel="stylesheet" href="~/vendor/libs/bootstrap-daterangepicker/bootstrap-daterangepicker.css" />
	<link rel="stylesheet" href="~/vendor/libs/jquery-timepicker/jquery-timepicker.css" />
	<link rel="stylesheet" href="~/vendor/libs/pickr/pickr-themes.css" />

	<link href="~/vendor/css/pages/front-page-landing.css" rel="stylesheet" />
	<link href="~/css/taxitripsindex.css" rel="stylesheet" />
}

@section VendorScripts {
	<script src="~/libs/jquery.js"> </script>
	<script src="~/vendor/libs/moment/moment.js"></script>
	<script src="~/vendor/libs/jdate/jdate.min.js"></script>
	<script src="~/vendor/libs/flatpickr/flatpickr-jdate.js"></script>
	<script src="~/vendor/libs/flatpickr/l10n/fa.js"></script>
	<script src="~/vendor/libs/bootstrap-datepicker/bootstrap-datepicker.js"></script>
	<script src="~/vendor/libs/bootstrap-daterangepicker/bootstrap-daterangepicker.js"></script>
	<script src="~/vendor/libs/jquery-timepicker/jquery-timepicker.js"></script>
	<script src="~/vendor/libs/pickr/pickr.js"></script>
}

@section PageScripts {
	<script src="~/js/forms-pickers-jalali.js"></script>
	<script src="~/js/ui-modals.js"></script>

}
@* ************** Content ************** *@


<style>
	.daytext {
		text-align: center;
	}

	.tripday {
		align-items: stretch;
		border-radius: 8px !important;
		cursor: pointer;
		display: flex;
		flex-direction: column;
		flex-shrink: 0;
		justify-content: center;
		margin: 0 6px;
		padding: 0 4px;
		position: relative;
		-webkit-user-select: none;
		-moz-user-select: none;
		user-select: none;
	}

	.switchbar-container {
		display: flex;
		align-items: center;
		max-width: 100%;
		flex-direction: row !important;
	}

	.scroll_button {
		padding: 8px;
		width: 48px;
		background: none;
		border: none;
		color: inherit;
		cursor: pointer;
		outline: none;
		align-self: stretch;
	}

	.timelline-container {
		align-items: center;
		display: flex;
		overflow-x: scroll;
		overflow-y: hidden;
		padding-bottom: 8px;
		scrollbar-width: none;
	}

	/* Ticket card enhancements */
	.ticket-card-cancelled {
		opacity: 0.75;
		border-left: 4px solid #ff4c51 !important;
	}

	.ticket-card-active {
		border-left: 4px solid #28c76f !important;
	}

	.custom-option-content:hover {
		border-color: var(--bs-primary) !important;
	}

	.custom-option-content input:checked ~ .custom-option-header {
		color: var(--bs-primary);
	}

	/* Flatpickr z-index fix - ensure calendar appears above modal */
	.flatpickr-calendar {
		z-index: 9999 !important;
	}

	.flatpickr-calendar.open {
		z-index: 9999 !important;
	}

	/* Ensure modal backdrop doesn't cover flatpickr */
	.modal-backdrop {
		z-index: 1050 !important;
	}

	.modal {
		z-index: 1055 !important;
	}
</style>
<style>


	@@media only screen and (min-width: 960px) {
		.px-lg-6 {
			padding-right: 2.6rem !important;
			padding-left: 2.6rem !important;
		}
	}

	@@media only screen and (min-width: 1200px) {
		.px-lg-6 {
			padding-right: 8rem !important;
			padding-left: 8rem !important;
		}
	}
</style>
<style>
	.submitation {
		max-width: 160px;
		flex: 1;
	}

	.direction-container {
	}

	.transport {
		flex-grow: 3;
		max-width: 300px;
	}

	.trip-info {
		display: flex;
		flex-direction: row;
		justify-content: space-between;
	}


	@@media only screen and (max-width: 600px) {
		.trip-info {
			display: flex;
			flex-direction: column;
			justify-content: space-between;
		}

		.provider h5 {
			font-size: initial;
		}

		.starttime, .endtime {
			font-size: 1.1rem !important;
		}

		.transport {
			padding-left: 1.5rem;
			padding-right: 1.2rem;
			margin: 0 !important;
		}

		.submitation {
			flex-direction: row !important;
			max-width: unset !important;
			justify-content: space-between !important;
			padding-left: 1rem;
		}
	}

	.transport {
		margin-right: 3.6rem;
	}

	.fa-taxiSide {
		height: 1.2em;
	}

	.price {
		color: #0b5fb3;
		font-size: 20px;
		font-style: normal;
		font-variation-settings: "wght" 700;
		font-weight: 700;
		text-align: right;
	}

	.orgprice {
		color: #8d99a6;
		font-size: 15px;
		font-style: normal;
		font-variation-settings: "wght" 500;
		font-weight: 500;
		text-align: right;
		text-decoration: line-through;
	}

	.logo-image {
		height: 40px;
		-o-object-fit: contain;
		object-fit: contain;
		width: 40px;
	}


	.leftside {
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.directionval {
		font-weight: 400;
		font-size: 14px;
		font-style: normal;
		font-variation-settings: "wght" 400;
		font-weight: 400;
		line-height: 28px;
	}


	.mainbody {
		display: flex;
		justify-content: space-between;
	}

	.provider {
		text-align: center;
	}

	.starttime, .endtime {
		font-size: 1.7rem;
	}

	.tripcardheader {
		display: flex;
		justify-content: space-between;
		align-items: start;
	}

	.carmodel {
		color: black !important;
	}

	.direction-container {
		display: flex;
		flex-direction: column;
		justify-content: start;
	}

	.landing-hero {
		background-color: hsla(213.08823529411762, 0%, 93%, 1) !important;
		background-image: radial-gradient(circle at 83% 22%, hsla(35.735294117647136, 82%, 87%, 1) 0%, transparent 50%), radial-gradient(circle at 0% 50%, hsla(194.5588235294118, 37%, 91%, 1) 0%, transparent 50%), radial-gradient(circle at 21% 21%, hsla(27.999999999999577, 0%, 86%, 1) 0%, transparent 50%), radial-gradient(circle at 54% 77%, hsla(193.2352941176474, 100%, 95%, 1) 0%, transparent 50%), radial-gradient(circle at 30% 75%, hsla(197.87234042553195, 25%, 35%, 1) 0%, transparent 20%) !important;
		background-blend-mode: normal, normal, normal, normal, normal !important;
	}
</style>


<div class="px-lg-6 px-0 mt-4">

	<div class="searchbar card shadow card rounded-5 p-4">

		<div class="row">

			<div class="d-flex justify-content-between align-items-start">

				@{
					var hasFilters = !String.IsNullOrEmpty(ViewBag.dateFilter) || !String.IsNullOrEmpty(ViewBag.statusFilter);
					
					if (hasFilters)
					{
						<div>
							<h3 class="mb-1">
								بلیط‌های فیلتر شده
							</h3>
							@if (!String.IsNullOrEmpty(ViewBag.dateFilter))
							{
								<h6 class="fw-normal text-muted">
									<i class="ti ti-calendar"></i>
									بازه: @ViewBag.dateFilter
								</h6>
							}
							@if (!String.IsNullOrEmpty(ViewBag.statusFilter))
							{
								<h6 class="fw-normal text-muted">
									<i class="ti ti-filter"></i>
									وضعیت: 
									@if (ViewBag.statusFilter == "active")
									{
										<span class="badge bg-label-success">فعال</span>
									}
									else if (ViewBag.statusFilter == "cancelled")
									{
										<span class="badge bg-label-danger">کنسل شده</span>
									}
								</h6>
							}
						</div>
					}
					else
					{
						<h3>
							آخرین بلیط‌ها
						</h3>
					}
				}

				<div class="d-flex gap-2">
					@if (hasFilters)
					{
						<a class="btn btn-label-secondary" asp-action="Index">
							<i class="ti ti-x"></i>
							حذف فیلترها
						</a>
					}
					<button class="btn btn-primary" data-bs-target="#filterModal" data-bs-toggle="modal">
						<i class="ti ti-filter"></i>
						فیلتر
					</button>
				</div>
			</div>

			<!-- Statistics Cards -->
			<div class="row mt-3 mb-2">
				<div class="col-md-4 col-12 mb-2">
					<div class="card border shadow-none">
						<div class="card-body p-3">
							<div class="d-flex align-items-center">
								<div class="avatar me-3">
									<span class="avatar-initial rounded bg-label-primary">
										<i class="ti ti-ticket ti-md"></i>
									</span>
								</div>
								<div>
									<p class="mb-0 text-muted small">کل بلیط‌ها</p>
									<h4 class="mb-0">@ViewBag.totalTickets</h4>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4 col-12 mb-2">
					<div class="card border shadow-none">
						<div class="card-body p-3">
							<div class="d-flex align-items-center">
								<div class="avatar me-3">
									<span class="avatar-initial rounded bg-label-success">
										<i class="ti ti-check ti-md"></i>
									</span>
								</div>
								<div>
									<p class="mb-0 text-muted small">بلیط‌های فعال</p>
									<h4 class="mb-0">@ViewBag.activeTickets</h4>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-4 col-12 mb-2">
					<div class="card border shadow-none">
						<div class="card-body p-3">
							<div class="d-flex align-items-center">
								<div class="avatar me-3">
									<span class="avatar-initial rounded bg-label-danger">
										<i class="ti ti-x ti-md"></i>
									</span>
								</div>
								<div>
									<p class="mb-0 text-muted small">کنسل شده</p>
									<h4 class="mb-0">@ViewBag.cancelledTickets</h4>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="py-2">

				@if (ViewBag.tickets.Count < 1)
				{
					var hasActiveFilters = !String.IsNullOrEmpty(ViewBag.dateFilter) || (!String.IsNullOrEmpty(ViewBag.statusFilter) && ViewBag.statusFilter != "all");
					
					if (hasActiveFilters)
					{
						<div class="col-12 d-flex text-center align-items-center py-5 mt-3" style="flex-direction: column;">
							<div class="avatar avatar-lg mb-3">
								<span class="avatar-initial rounded-circle bg-label-warning">
									<i class="ti ti-search-off ti-lg"></i>
								</span>
							</div>
							<h5 class="mb-2">
								بلیطی یافت نشد
							</h5>
							<p class="text-muted mb-3">
								با فیلترهای انتخاب شده، بلیطی پیدا نشد.
								<br/>
								می‌توانید فیلترها را تغییر دهید یا حذف کنید.
							</p>
							<div class="d-flex gap-2">
								<button class="btn btn-primary" data-bs-target="#filterModal" data-bs-toggle="modal">
									<i class="ti ti-filter"></i>
									تغییر فیلتر
								</button>
								<a class="btn btn-label-secondary" asp-action="Index">
									<i class="ti ti-x"></i>
									حذف فیلترها
								</a>
							</div>
						</div>
					}
					else
					{
						<div class="col-12 d-flex text-center align-items-center py-5 mt-3" style="flex-direction: column;">
							<div class="avatar avatar-lg mb-3">
								<span class="avatar-initial rounded-circle bg-label-primary">
									<i class="ti ti-ticket-off ti-lg"></i>
								</span>
							</div>
							<h5 class="mb-2">
								هنوز بلیطی وجود ندارد
							</h5>
							<p class="text-muted mb-3">
								شما هنوز بلیطی خریداری نکرده‌اید.
								<br/>
								می‌توانید از دکمه زیر سفرهای سواری را جستجو کنید.
							</p>
							<a class="btn btn-primary btn-lg" asp-controller="Home" asp-action="Index">
								<i class="ti ti-search"></i>
								جستجوی سفرها
							</a>
						</div>
					}
				}

				@foreach (Ticket ticket in ViewBag.tickets)
				{
					<div class="col-12 card rounded-5 p-3 mt-2 @(ticket.IsCancelled ? "ticket-card-cancelled" : "ticket-card-active")">

						<div class="col-12 row rounded-5 p-0 ">
							<div class="d-flex justify-content-between align-items-start col-12 mb-2">
								<div class="d-flex align-items-center">
									@if (ticket.IsCancelled)
									{
										<span class="badge bg-label-danger me-2">
											<i class="ti ti-x ti-xs"></i>
											کنسل شده
										</span>
									}
									else
									{
										<span class="badge bg-label-success me-2">
											<i class="ti ti-check ti-xs"></i>
											فعال
										</span>
									}
									<small class="text-muted">
										کد رزرو: <strong>@ticket.TicketCode</strong>
									</small>
								</div>
								@if (ticket.IsCancelled)
								{
									<span class="badge bg-label-secondary">
										تاریخ کنسلی: @ticket.RegisteredAt.ToPersianDate().ToShortDateString()
									</span>
								}
							</div>

							<div class="d-flex justify-content-center align-items-center col-6 col-md-1 ps-1">
								@* <svg xmlns="http://www.w3.org/2000/svg" width="70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-ticket">
							<path stroke="none" d="M0 0h24v24H0z" fill="none" />
							<path d="M15 5l0 2" />
							<path d="M15 11l0 2" />
							<path d="M15 17l0 2" />
							<path d="M5 5h14a2 2 0 0 1 2 2v3a2 2 0 0 0 0 4v3a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-3a2 2 0 0 0 0 -4v-3a2 2 0 0 1 2 -2" />
							</svg> *@

								@{
									if (ticket.Gender == "male")
									{
										<img src="~/male.png" height="60" />

									}
									else
									{
										<img src="~/female.png" height="60" />
									}
								}


							</div>

							<div class="d-flex col-6 col-md-3" style="flex-direction: column">
								<h5 class="mb-1">
									اطلاعات خریدار
								</h5>

								<div class="ps-1">
									<div class="">
										<lable class="fw-bold">
											نام :
										</lable>
										<label>
											@ticket.Firstname
										</label>
									</div>

									<div class="">
										<lable class="fw-bold">
											نام‌خانوادگی :
										</lable>
										<label>
											@ticket.Lastname
										</label>
									</div>

									<div class="">
										<lable class="fw-bold">
											شماره تلفن :
										</lable>
										<label>
											<a href="tel:+98
@ticket.PhoneNumber
		">@ticket.PhoneNumber</a>
										</label>
									</div>

								</div>
							</div>

							<div class="d-flex col-6 col-md-3" style="flex-direction: column">
								<h5 class="mb-1">
									اطلاعات سفر
								</h5>

								<div class="ps-1">
									<div class="">
										<lable class="fw-bold">
											@ticket.ServiceName
										</lable>
									</div>

									<div class="">
										<lable class="fw-bold">
											مسیر :
										</lable>
										<label>
											<span class="fw-bold">
												@ticket.TripOrigin
											</span>
											به
											<span class="fw-bold">
												@ticket.TripDestination
											</span>
										</label>
									</div>

									<div class="">
										<lable class="fw-bold">
											خودرو :
										</lable>
										<label>
											@ticket.CarName
										</label>
									</div>

								</div>
							</div>
							<div class="d-flex col-6 col-md-3" style="flex-direction: column">
								<h5 class="mb-1">
									اطلاعات خرید
								</h5>

								<div class="ps-1">
									<div class="">
										<lable class="fw-bold">
											تاریخ خرید :
										</lable>
										<label>
											@ticket.RegisteredAt.ToString("HH:mm")
											-
											@ticket.RegisteredAt.ToPersianDate().ToShortDateString()
										</label>
									</div>

									<div class="">
										<lable class="fw-bold">
											قیمت :
										</lable>
										<label>
											@ticket.TicketFinalPrice.ToString("N0")
										</label>
									</div>

								</div>
							</div>
							<div class="d-flex col-12 col-md-2 P-0 align-self-center" style="flex-direction: column">

								<a class="btn btn-secondary px-0" asp-area="AgencyArea" asp-controller="CustomerService" asp-action="TripReceiptPDF" asp-route-reference="@ticket.TicketCode">

									<i class="ti ti-printer"></i>
									چاپ بلیط
								</a>
							</div>

						</div>

					</div>
				}
			</div>
		</div>

	</div>

	<div class="row mt-2">
	</div>

</div>

<div class="col-12">
	<small class="text-light fw-medium"></small>
	<div class="mt-4">
		<!-- Filter Modal -->
		<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<div class="d-flex justify-content-start align-items-center w-100">
							<i class="ti ti-filter ti-lg text-primary me-2"></i>
							<div class="flex-grow-1">
								<h3 class="modal-title mb-0" id="filterModalLabel">فیلتر بلیط‌ها</h3>
								<small class="text-muted">
									فیلتر بلیط‌های خریداری شده
								</small>
							</div>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
					</div>
					<div class="modal-body pb-3">
						<form asp-action="Filter" method="get">
							<!-- Date Range Filter - NOW AT THE TOP -->
							<div class="mb-4">
								<h5 class="mb-3">
									<i class="ti ti-calendar-month"></i>
									فیلتر بر اساس تاریخ خرید
								</h5>
								<small style="font-size: .75rem;" class="text-muted d-block mb-2">
									<i class="ti ti-info-circle"></i>
									بازه زمانی را انتخاب کنید (تقویم شمسی)
								</small>
								<input value="@ViewBag.dateFilter" name="datesFilter" class="form-control form-control-lg" id="bs-rangepicker-basic" type="text" placeholder="انتخاب بازه تاریخ...">
							</div>

							<hr class="my-4" />

							<!-- Status Filter - NOW AT THE BOTTOM -->
							<div class="mb-3">
								<h5 class="mb-3">
									<i class="ti ti-checkbox"></i>
									وضعیت بلیط
								</h5>
								<div class="row">
									<div class="col-12">
										<div class="form-check custom-option custom-option-basic mb-2">
											<label class="form-check-label custom-option-content" for="statusAll">
												<input class="form-check-input" type="radio" name="statusFilter" value="all" id="statusAll" 
													@(String.IsNullOrEmpty(ViewBag.statusFilter) || ViewBag.statusFilter == "all" ? "checked" : "") />
												<span class="custom-option-header">
													<span class="h6 mb-0">
														<i class="ti ti-list"></i>
														همه بلیط‌ها
													</span>
												</span>
											</label>
										</div>
									</div>
									<div class="col-12">
										<div class="form-check custom-option custom-option-basic mb-2">
											<label class="form-check-label custom-option-content" for="statusActive">
												<input class="form-check-input" type="radio" name="statusFilter" value="active" id="statusActive"
													@(ViewBag.statusFilter == "active" ? "checked" : "") />
												<span class="custom-option-header">
													<span class="h6 mb-0">
														<i class="ti ti-check text-success"></i>
														فقط فعال
													</span>
												</span>
											</label>
										</div>
									</div>
									<div class="col-12">
										<div class="form-check custom-option custom-option-basic mb-2">
											<label class="form-check-label custom-option-content" for="statusCancelled">
												<input class="form-check-input" type="radio" name="statusFilter" value="cancelled" id="statusCancelled"
													@(ViewBag.statusFilter == "cancelled" ? "checked" : "") />
												<span class="custom-option-header">
													<span class="h6 mb-0">
														<i class="ti ti-x text-danger"></i>
														فقط کنسل شده
													</span>
												</span>
											</label>
										</div>
									</div>
								</div>
							</div>

							<div class="d-flex gap-2 mt-4">
								<button type="submit" class="btn btn-primary flex-grow-1">
									<i class="ti ti-search"></i>
									اعمال فیلتر
								</button>
								<a asp-action="Index" class="btn btn-label-secondary">
									<i class="ti ti-x"></i>
									پاک کردن
								</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<div class="pb-5">
</div>


