# âœ… Mock Payment Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…Ø­Ù„ÛŒ - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„

## ğŸ¯ Ù‡Ø¯Ù

Ø§Ù…Ú©Ø§Ù† ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø¯Ø§Ø®Øª **Ø±ÙˆÛŒ localhost Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Zarinpal ÙˆØ§Ù‚Ø¹ÛŒ ÛŒØ§ ngrok**.

---

## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª

### **Ø¯Ø± `appsettings.Development.json`:**

```json
{
  "Zarinpal": {
    "UseMockPayment": true,
    "CallbackUrl": "http://localhost:5055/Payment/Verify"
  }
}
```

### **Ø¯Ø± `appsettings.json` (Production):**

```json
{
  "Zarinpal": {
    "UseMockPayment": false,
    "CallbackUrl": "https://mrshoofer.ir/Payment/Verify"
  }
}
```

---

## ğŸš€ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡

### **1. Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡**
```sh
dotnet run
```

### **2. Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø±ÙˆØ±Ú¯Ø±**
```
http://localhost:5055
```

### **3. Ø¬Ø±ÛŒØ§Ù† ØªØ³Øª:**

```
Ú©Ø§Ø±Ø¨Ø±: Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙØ±
    â†“
Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø±Ø²Ø±Ùˆ
    â†“
Ú©Ù„ÛŒÚ© "ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª"
    â†“
âœ… Ø§ÛŒØ¬Ø§Ø¯ Ticket Ø¨Ø§ Authority ØªØ³ØªÛŒ (MOCK-xxx)
    â†“
Redirect Ø¨Ù‡: /Payment/MockGateway
    â†“
ğŸ“± ØµÙØ­Ù‡ Mock Gateway Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡
    â†“
    â”œâ”€ Ú©Ù„ÛŒÚ© "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚"
    â”‚      â†“
    â”‚   Redirect: /Payment/Verify?Authority=MOCK-xxx&Status=OK
    â”‚      â†“
    â”‚   âœ… Verify Ù…ÙˆÙÙ‚ (Mock RefId)
    â”‚      â†“
    â”‚   âœ… Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø²Ø±Ùˆ Ø¯Ø± MrShoofer
    â”‚      â†“
    â”‚   âœ… Update Ticket: IsPaid=true
    â”‚      â†“
    â”‚   ğŸ“„ ØµÙØ­Ù‡ ReserveConfirmed
    â”‚      â†“
    â”‚   ğŸ“§ Ø§Ø±Ø³Ø§Ù„ SMS Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ
    â”‚
    â””â”€ Ú©Ù„ÛŒÚ© "âŒ Ø§Ù†ØµØ±Ø§Ù"
           â†“
       Redirect: /Payment/Verify?Authority=MOCK-xxx&Status=NOK
           â†“
       âŒ ØµÙØ­Ù‡ PaymentFailed
```

---

## ğŸ“Š ØªÙØ§ÙˆØª Mock Ùˆ Real

| ÙˆÛŒÚ˜Ú¯ÛŒ | Mock Payment | Real Zarinpal |
|-------|-------------|---------------|
| **Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª** | âŒ Ø®ÛŒØ± | âœ… Ø¨Ù„Ù‡ |
| **Ù†ÛŒØ§Ø² Ø¨Ù‡ MerchantId** | âŒ Ø®ÛŒØ± | âœ… Ø¨Ù„Ù‡ |
| **Ù†ÛŒØ§Ø² Ø¨Ù‡ ngrok** | âŒ Ø®ÛŒØ± | âœ… Ø¨Ù„Ù‡ (Ø¨Ø±Ø§ÛŒ localhost) |
| **Ù¾ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ** | âŒ Ø®ÛŒØ± | âœ… Ø¨Ù„Ù‡ |
| **Authority** | `MOCK-{guid}` | Ø§Ø² Zarinpal |
| **RefId** | Random number | Ø§Ø² Zarinpal |
| **CardPan** | `6219-86**-****-1234` | Ú©Ø§Ø±Øª ÙˆØ§Ù‚Ø¹ÛŒ |
| **MrShoofer Reservation** | âœ… Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒØ´Ù‡ | âœ… Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒØ´Ù‡ |
| **Database** | âœ… Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡ | âœ… Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡ |

---

## ğŸ§ª ØµÙØ­Ù‡ Mock Gateway

### **Ø¸Ø§Ù‡Ø± ØµÙØ­Ù‡:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§ª Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ³ØªÛŒ (Mock)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš ï¸ Ø§ÛŒÙ† ÛŒÚ© Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ³ØªÛŒ Ø§Ø³Øª      â”‚
â”‚                                        â”‚
â”‚  Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:                    â”‚
â”‚  2,890,000 ØªÙˆÙ…Ø§Ù†                       â”‚
â”‚  (28,900,000 Ø±ÛŒØ§Ù„)                     â”‚
â”‚                                        â”‚
â”‚  Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ±Ø§Ú©Ù†Ø´:                       â”‚
â”‚  Ú©Ø¯ ØªØ±Ø§Ú©Ù†Ø´: MOCK-abc123...            â”‚
â”‚  Ù…Ø³Ø§ÙØ±: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ                      â”‚
â”‚  Ù…Ø³ÛŒØ±: ØªÙ‡Ø±Ø§Ù† â†’ Ø§ØµÙÙ‡Ø§Ù†                 â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âŒ Ø§Ù†ØµØ±Ø§Ù Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Logs

### **Ú©Ù„ÛŒÚ© "Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚":**

```
info: ZarinpalService[0]
      ğŸ§ª MOCK: Payment request created. Authority: MOCK-abc123, Amount: 28900000

info: ZarinpalService[0]
      ğŸ§ª MOCK: Payment verified. RefId: 123456789, Authority: MOCK-abc123

info: PaymentController[0]
      Payment verified successfully. RefId: 123456789

info: MrShooferAPIClient[0]
      Creating MrShoofer reservation. TripCode: GJBK3RH

info: PaymentController[0]
      MrShoofer reservation confirmed. TicketCode: A1B2C3
```

### **Ú©Ù„ÛŒÚ© "Ø§Ù†ØµØ±Ø§Ù":**

```
warn: PaymentController[0]
      Payment cancelled by user. Authority: MOCK-abc123

info: PaymentController[0]
      Redirecting to PaymentFailed
```

---

## âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

### **1. ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Development**

Mock Payment **ÙÙ‚Ø·** Ø¯Ø± Ù…Ø­ÛŒØ· Development ÙØ¹Ø§Ù„ Ú©Ù†:

```json
// âŒ NEVER in production!
{
  "Zarinpal": {
    "UseMockPayment": true  // â† Ø®Ø·Ø±Ù†Ø§Ú© Ø¯Ø± production!
  }
}
```

### **2. Ø±Ø²Ø±Ùˆ ÙˆØ§Ù‚Ø¹ÛŒ Ø¯Ø± MrShoofer**

Ø­ØªÛŒ Ø¯Ø± Mock modeØŒ Ø±Ø²Ø±Ùˆ Ø¯Ø± MrShoofer API **ÙˆØ§Ù‚Ø¹ÛŒ** Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒØ´Ù‡!

- âœ… Ticket Ø¯Ø± database Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡
- âœ… MrShoofer reservation Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒØ´Ù‡
- âœ… SMS Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒØ´Ù‡

**Ù¾Ø³:** Ù…Ø«Ù„ production Ø±ÙØªØ§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡ØŒ ÙÙ‚Ø· Ù¾Ø±Ø¯Ø§Ø®Øª fake Ø§Ø³Øª!

### **3. ØªØ³Øª Integration Ú©Ø§Ù…Ù„**

Mock Payment Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒØ¯Ù‡ ØªØ³Øª Ú©Ù†ÛŒ:
- âœ… UI flow
- âœ… Database operations
- âœ… MrShoofer API integration
- âœ… SMS sending
- âœ… Error handling

Ø¨Ø¯ÙˆÙ†:
- âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ
- âŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ ngrok
- âŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ MerchantId Ù…Ø¹ØªØ¨Ø±

---

## ğŸ› Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ

### **Mock Gateway Ø¨Ø§Ø² Ù†Ù…ÛŒØ´Ù‡:**

**Ú†Ú© Ú©Ù†:**
```json
"UseMockPayment": true  // â† Ø¯Ø± appsettings.Development.json
```

### **ØµÙØ­Ù‡ Ø¨Ù‡ Zarinpal ÙˆØ§Ù‚Ø¹ÛŒ Ù…ÛŒØ±Ù‡:**

**Ø¯Ù„ÛŒÙ„:** `UseMockPayment: false` Ù‡Ø³Øª

**Ø±Ø§Ù‡â€ŒØ­Ù„:**
1. `appsettings.Development.json` Ø±Ùˆ Ø¨Ø§Ø² Ú©Ù†
2. `"UseMockPayment": true` ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
3. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ùˆ restart Ú©Ù†

### **Ø®Ø·Ø§ÛŒ Layout:**

Ø§Ú¯Ù‡ Ø®Ø·Ø§ÛŒ `_CommonMasterLayout not found` Ø¯ÛŒØ¯ÛŒ:

**Ø±Ø§Ù‡â€ŒØ­Ù„:** Ù‡Ù…Ù‡ Payment views Ø§Ø² `_PaymentLayout.cshtml` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù† Ú©Ù‡ dependency Ù†Ø¯Ø§Ø±Ù‡.

---

## ğŸ“‹ Checklist Ù‚Ø¨Ù„ Ø§Ø² Production

Ù‚Ø¨Ù„ Ø§Ø² deploy:

- [ ] `"UseMockPayment": false` Ø¯Ø± `appsettings.json`
- [ ] MerchantId ÙˆØ§Ù‚Ø¹ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
- [ ] CallbackUrl Ø¨Ø§ Ø¯Ø§Ù…Ù†Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ
- [ ] Test Ø¨Ø§ Zarinpal sandbox
- [ ] Test Ø¨Ø§ Ù¾ÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ (Ù…Ø¨Ù„Øº Ú©Ù…)

---

## ğŸ“ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ

Ø§ÛŒÙ† Mock Payment Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡:
1. ğŸ§ª ØªØ³Øª Ø³Ø±ÛŒØ¹ Ø¨Ø¯ÙˆÙ† dependency Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
2. ğŸ› Debug flow Ø¨Ø¯ÙˆÙ† Ù‡Ø²ÛŒÙ†Ù‡
3. ğŸ“š ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ú©Ø§Ù…Ù„ Ø¬Ø±ÛŒØ§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª
4. âœ… ØªØ³Øª error scenarios (Ø§Ù†ØµØ±Ø§ÙØŒ timeoutØŒ etc)

---

**Ù†Ø³Ø®Ù‡:** 1.0  
**Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:** 2024-12-16  
**Ù…Ø­ÛŒØ·:** Development Only âš ï¸
